# 数据大屏接口文档

> **版本：** v1.5.0  
> **更新日期：** 2025-11-20  
> **说明：** 本文档包含数据大屏所有相关接口，已与实际代码进行深度对比检查，确保与小程序和后台管理系统完全匹配

## ⚠️ 重要说明：多直播流独立处理

**所有功能都支持多直播流独立管理，每个直播流拥有：**
- ✅ 独立的票数数据（正方/反方票数）
- ✅ 独立的评委配置（3位评委信息）
- ✅ 独立的辩论流程配置（环节、时长、顺序）
- ✅ 独立的流程控制状态（计时器、当前环节）

**所有接口都必须支持 `stream_id` 参数，用于指定操作的直播流。**

---

## 📋 目录

1. [评委管理接口](#1-评委管理接口)
2. [辩论流程控制接口](#2-辩论流程控制接口)
3. [票数管理接口](#3-票数管理接口)
4. [数据大屏数据接口](#4-数据大屏数据接口)
5. [WebSocket推送事件](#5-websocket推送事件)

---

## 1. 评委管理接口

> **✅ 已实现，直接使用**
> - `GET /api/admin/judges?stream_id=xxx` - 获取评委配置
> - `POST /api/admin/judges` - 保存评委配置（支持stream_id参数，每个流独立配置）

---

## 2. 辩论流程控制接口

> **✅ 已实现，直接使用**
> - `GET /api/admin/debate-flow?stream_id=xxx` - 获取辩论流程配置
> - `POST /api/admin/debate-flow` - 保存辩论流程配置（支持stream_id参数，每个流独立配置）
> - `POST /api/admin/debate-flow/control` - 发送流程控制命令（支持stream_id参数，action: start/pause/resume/reset/next/prev）

---

## 3. 票数管理接口

> **✅ 已实现，直接使用**
> - `GET /api/admin/votes` 或 `GET /api/admin/dashboard` - 获取票数数据（数据大屏复用小程序已有接口，统一数据源）
> - `PUT /api/admin/votes` - 设置票数（覆盖）
> - `POST /api/admin/live/update-votes` - 更新票数（支持action: set/add，支持streamId参数）

> **说明：** 票数数据通过小程序投票接口自动更新，后台管理系统仅用于查看、设置和增加

---

## 4. 数据大屏数据接口

> **✅ 已实现，直接使用**
> - `GET /api/admin/dashboard` - 获取票数数据（**数据大屏复用小程序已有接口，统一数据源**，推荐使用，返回更完整的数据）
> - `GET /api/admin/votes` - 获取票数数据（更简洁的接口）
> - `GET /api/admin/streams` - 获取直播流列表（**数据大屏复用小程序已有接口，统一数据源**）

---

## 5. WebSocket推送事件

数据大屏通过WebSocket接收实时更新。WebSocket连接地址：与页面同源的 `/ws`，例如 `ws://localhost:8084/ws`

### 5.1 评委信息更新事件

**事件类型：** `judges-updated`

**事件数据：**
```json
{
  "type": "judges-updated",
  "data": {
    "streamId": "stream-123",
    "judges": [
      {
        "id": "judge-1",
        "name": "张教授",
        "role": "主评委",
        "avatar": "data:image/png;base64,...",
        "leftVotes": 60,
        "rightVotes": 40
      },
      {
        "id": "judge-2",
        "name": "李老师",
        "role": "嘉宾评委",
        "avatar": "data:image/png;base64,...",
        "leftVotes": 50,
        "rightVotes": 50
      },
      {
        "id": "judge-3",
        "name": "王专家",
        "role": "嘉宾评委",
        "avatar": "data:image/png;base64,...",
        "leftVotes": 40,
        "rightVotes": 60
      }
    ],
    "timestamp": "2025-11-15T10:30:00.000Z"
  }
}
```

**触发时机：**
- 当后台管理系统保存评委配置时，后端自动广播此事件

**数据大屏处理：**
- ⚠️ **多流支持**：数据大屏会检查 `streamId` 是否与当前选择的流匹配
- 如果 `streamId` 匹配或事件中没有 `streamId`，则更新评委信息显示
- 如果 `streamId` 不匹配，忽略此事件（其他流的更新）
- 更新评委投票对抗条
- 更新评委卡片中的票数

---

### 5.2 辩论流程配置更新事件

**事件类型：** `debate-flow-updated`

**事件数据：**
```json
{
  "type": "debate-flow-updated",
  "data": {
    "streamId": "stream-123",
    "flow": [
      {
        "name": "正方发言",
        "duration": 180,
        "side": "left",
        "order": 1
      },
      {
        "name": "反方质问",
        "duration": 120,
        "side": "right",
        "order": 2
      }
      // ... 更多环节
    ],
    "timestamp": "2025-11-15T10:30:00.000Z"
  }
}
```

**触发时机：**
- 当后台管理系统保存辩论流程配置时，后端自动广播此事件

**数据大屏处理：**
- ⚠️ **多流支持**：数据大屏会检查 `streamId` 是否与当前选择的流匹配
- 如果 `streamId` 匹配或事件中没有 `streamId`，则更新 `DEBATE_SEGMENTS` 配置
- 如果 `streamId` 不匹配，忽略此事件（其他流的更新）
- 如果当前没有进行计时，更新环节显示

---

### 5.3 辩论流程控制命令事件

**事件类型：** `debate-flow-control`

**事件数据：**
```json
{
  "type": "debate-flow-control",
  "data": {
    "streamId": "stream-123",
    "action": "start",
    "segmentIndex": 0,
    "timestamp": "2025-11-15T10:30:00.000Z"
  }
}
```

**action 可选值：**
- `start` - 开始辩论
- `pause` - 暂停计时
- `resume` - 继续计时
- `reset` - 重置流程
- `next` - 下一环节
- `prev` - 上一环节

**触发时机：**
- 当后台管理系统发送流程控制命令时，后端自动广播此事件

**数据大屏处理：**
- ⚠️ **多流支持**：数据大屏会检查 `streamId` 是否与当前选择的流匹配
- 如果 `streamId` 匹配，执行相应的控制操作：
  - `start`: 从指定环节或第一个环节开始计时
  - `pause`: 暂停当前计时器
  - `resume`: 继续计时
  - `reset`: 重置计时器和环节状态
  - `next`: 切换到下一个环节
  - `prev`: 切换到上一个环节
- 如果 `streamId` 不匹配，忽略此事件（其他流的控制命令不影响当前流）
- **重要**：不同直播流的计时器状态完全独立，互不影响

---

### 5.4 票数更新事件（已存在）

**事件类型：** `votes-updated` 或 `vote-updated`

**事件数据：**
```json
{
  "type": "votes-updated",
  "data": {
    "leftVotes": 12345,
    "rightVotes": 10234,
    "totalVotes": 22579,
    "leftPercentage": 55,
    "rightPercentage": 45,
    "streamId": "stream-123",
    "userVote": {
      "userId": "user-123",
      "leftVotes": 60,
      "rightVotes": 40,
      "mode": "100票分配制"
    },
    "timestamp": "2025-11-15T10:30:00.000Z"
  }
}
```

**字段说明：**

| 字段名 | 类型 | 说明 |
|--------|------|------|
| leftVotes | number | 正方总票数 |
| rightVotes | number | 反方总票数 |
| totalVotes | number | 总票数 |
| leftPercentage | number | 正方百分比 |
| rightPercentage | number | 反方百分比 |
| streamId | string | 直播流ID（可选，如果提供，数据大屏会根据此字段过滤） |
| userVote | object | 用户投票详情（可选） |
| timestamp | string | 更新时间 |

**触发时机：**
- 当小程序用户投票时（`POST /api/user-vote`）
- 当后台管理系统设置/增加票数时
- 后端自动广播此事件

**数据大屏处理：**
- ⚠️ **多流支持**：数据大屏会检查 `streamId` 是否与当前选择的流匹配
- 如果 `streamId` 匹配或事件中没有 `streamId`，更新票数显示
- 如果 `streamId` 不匹配，忽略此事件（其他流的更新不影响当前流）
- 记录票数变化到 `voteHistory`（用于趋势图表，按流分开记录）
- 更新票数对抗条的宽度和百分比
- **切换流时**：清空当前流的 `voteHistory`，重新开始记录新流的票数变化

---

## 6. 接口实现状态

> **✅ 所有接口已实现，可直接使用**
> 
> 所有接口已在server.js中实现，数据大屏和后台管理系统可以直接使用。详细接口列表请参考前面的章节。

---

### ⚠️ 接口路径别名（可选，用于向后兼容）

如果后台管理系统需要使用v1版本的接口路径，可以在server.js中添加路由别名（复用已有处理逻辑）：

- `POST /api/v1/admin/live/update-votes` → 可指向 `POST /api/admin/live/update-votes`
- `GET /api/v1/admin/users` → 可指向 `GET /api/admin/users`
- `POST /api/v1/user-vote` → 可指向 `POST /api/user-vote`

**注意**：这些v1版本的路由别名不是必需的，可以直接使用非v1版本的接口路径。

### ✅ 已完整实现的联动功能（多流支持）

1. ✅ **小程序投票 → 数据大屏更新** - 通过WebSocket实时同步，**支持多流独立票数**
2. ✅ **后台管理 → 数据大屏同步** - 评委、流程、票数配置实时同步，**每个流独立配置**
3. ✅ **流程控制命令 → 数据大屏执行** - 开始、暂停、继续、重置等命令实时生效，**每个流独立控制**
4. ✅ **多流支持** - 所有接口和事件都支持 `stream_id` 参数，实现多流独立管理
5. ✅ **数据隔离** - 每个直播流的数据完全独立，互不影响
6. ✅ **消息过滤** - 数据大屏根据 `streamId` 严格过滤WebSocket消息，只处理匹配的流

---

## 7. 数据存储结构（多流独立存储）

### 7.1 评委数据存储

**文件路径：** `data/judges.json`

**数据结构：**
```json
[
  {
    "streamId": "stream-1",
    "judges": [
      {
        "id": "judge-1",
        "name": "张教授",
        "role": "主评委",
        "avatar": "data:image/png;base64,...",
        "leftVotes": 60,
        "rightVotes": 40
      },
      {
        "id": "judge-2",
        "name": "李老师",
        "role": "嘉宾评委",
        "avatar": "data:image/png;base64,...",
        "leftVotes": 50,
        "rightVotes": 50
      },
      {
        "id": "judge-3",
        "name": "王专家",
        "role": "嘉宾评委",
        "avatar": "data:image/png;base64,...",
        "leftVotes": 40,
        "rightVotes": 60
      }
    ],
    "updatedAt": "2025-11-15T10:30:00.000Z"
  },
  {
    "streamId": "stream-2",
    "judges": [
      {
        "id": "judge-1",
        "name": "赵教授",
        "role": "主评委",
        "avatar": "data:image/png;base64,...",
        "leftVotes": 70,
        "rightVotes": 30
      }
      // ... 其他评委
    ],
    "updatedAt": "2025-11-15T11:00:00.000Z"
  }
]
```

**多流存储说明：**
- ⚠️ **每个直播流有独立的评委配置记录**，通过 `streamId` 字段区分
- 不同流的评委配置完全独立，互不影响
- 查询时通过 `streamId` 过滤，只返回匹配流的配置

### 7.2 辩论流程数据存储

**文件路径：** `data/debate-flows.json`

**数据结构：**
```json
[
  {
    "streamId": "stream-1",
    "flow": [
      {
        "name": "正方发言",
        "duration": 180,
        "side": "left",
        "order": 1
      },
      {
        "name": "反方质问",
        "duration": 120,
        "side": "right",
        "order": 2
      }
      // ... 更多环节
    ],
    "updatedAt": "2025-11-15T10:30:00.000Z"
  },
  {
    "streamId": "stream-2",
    "flow": [
      {
        "name": "开场白",
        "duration": 60,
        "side": "both",
        "order": 1
      }
      // ... 不同的流程配置
    ],
    "updatedAt": "2025-11-15T11:00:00.000Z"
  }
]
```

**多流存储说明：**
- ⚠️ **每个直播流有独立的辩论流程配置记录**，通过 `streamId` 字段区分
- 不同流的流程配置完全独立，可以有不同的环节、时长、顺序
- 查询时通过 `streamId` 过滤，只返回匹配流的配置

### 7.3 票数数据存储（多流支持）

**存储方式：** 内存变量 + 数据库统计

**内存变量（按流存储）：**
```javascript
// 建议的数据结构
const streamVotes = {
  "stream-1": {
    leftVotes: 12345,
    rightVotes: 10234,
    updatedAt: "2025-11-15T10:30:00.000Z"
  },
  "stream-2": {
    leftVotes: 5678,
    rightVotes: 4321,
    updatedAt: "2025-11-15T11:00:00.000Z"
  }
};
```

**数据库统计（可选）：**
- 可以按 `streamId` 分别统计每个流的投票数据
- 支持按流查询历史投票记录

**多流存储说明：**
- ⚠️ **每个直播流有独立的票数数据**，通过 `streamId` 作为键区分
- 不同流的票数完全独立，互不影响
- 投票、设置、增加、重置操作都只影响指定的流

---

## 8. 错误码说明

| 错误码 | 说明 |
|--------|------|
| 400 | 请求参数错误（如缺少必填参数） |
| 404 | 资源不存在（如stream_id不存在） |
| 500 | 服务器内部错误 |

**错误响应格式：**
```json
{
  "success": false,
  "message": "错误描述信息"
}
```

---

## 9. 开发注意事项

### 9.1 评委管理（多流支持）

1. **多流独立配置：**
   - ⚠️ **每个直播流有独立的评委配置**，`stream_id` 参数是必填的
   - 不同直播流可以配置不同的评委（姓名、职位、头像）
   - 评委票数也是按流独立统计的

2. **头像存储：** 
   - 支持Base64编码的图片数据（前端直接上传）
   - 支持URL地址（从用户选择时使用）
   - 建议限制图片大小（如2MB以内）

3. **评委票数：**
   - 每个评委的 `leftVotes` + `rightVotes` 应该等于100（100票分配制）
   - 评委票数会单独统计，不影响普通用户票数
   - ⚠️ **每个流的评委票数独立统计**，互不影响

### 9.2 辩论流程控制（多流支持）

1. **多流独立配置：**
   - ⚠️ **每个直播流有独立的辩论流程配置**，`stream_id` 参数是必填的
   - 不同直播流可以配置不同的环节、时长、顺序
   - 每个流的计时器状态完全独立，互不影响

2. **流程配置：**
   - `order` 字段必须从1开始，连续递增
   - `duration` 建议范围：10-3600秒
   - `side` 只能是：`left`、`right`、`both`

3. **流程控制命令：**
   - 所有命令都会通过WebSocket实时推送到数据大屏
   - ⚠️ **命令必须包含 `stream_id`**，数据大屏会根据 `streamId` 过滤
   - 数据大屏只执行匹配的流的命令，其他流的命令不影响当前流
   - 建议在发送命令前验证 `stream_id` 是否存在
   - **重要**：可以同时控制多个流的流程，每个流独立运行

### 9.3 WebSocket推送（多流支持）

1. **事件广播（多流独立）：**
   - ⚠️ **所有WebSocket事件必须包含 `streamId` 字段**
   - 所有配置更新都会自动广播到所有连接的WebSocket客户端
   - 数据大屏会根据 `streamId` **严格过滤**，只处理匹配的流的更新
   - 不同直播流的事件互不影响，每个流独立处理

2. **多流消息过滤：**
   - 数据大屏维护当前选择的 `streamId`
   - 收到WebSocket消息时，检查 `message.data.streamId === currentStreamId`
   - 如果匹配，处理消息；如果不匹配，忽略消息
   - 这确保了不同流的数据不会互相干扰

3. **连接管理：**
   - 建议实现心跳机制保持连接
   - 实现断线重连逻辑
   - 处理连接异常情况
   - ⚠️ **切换流时，不需要重连WebSocket**，只需更新过滤条件

---

## 10. 测试建议

### 10.1 评委管理测试（多流支持）

1. 创建多个直播流（如 `stream-1`、`stream-2`）
2. 为 `stream-1` 配置3位评委信息（姓名、职位、头像）
3. 为 `stream-2` 配置不同的3位评委信息
4. 保存配置
5. 打开数据大屏，选择 `stream-1`，验证评委信息是否正确显示
6. 切换到 `stream-2`，验证显示的是 `stream-2` 的评委信息（与 `stream-1` 不同）
7. 在后台修改 `stream-1` 的评委信息，验证数据大屏（显示 `stream-1`）是否实时更新
8. 验证数据大屏（显示 `stream-2`）不受影响（不更新）

### 10.2 辩论流程控制测试（多流支持）

1. 创建多个直播流（如 `stream-1`、`stream-2`）
2. 为 `stream-1` 配置辩论流程（添加/删除/修改环节）
3. 为 `stream-2` 配置不同的辩论流程
4. 保存流程配置
5. 打开数据大屏A，选择 `stream-1`，验证流程是否正确加载
6. 打开数据大屏B，选择 `stream-2`，验证流程是否正确加载（与 `stream-1` 不同）
7. 在后台对 `stream-1` 发送控制命令（开始、暂停、继续、重置、下一环节、上一环节）
8. 验证数据大屏A（显示 `stream-1`）是否正确响应命令
9. 验证数据大屏B（显示 `stream-2`）不受影响（计时器状态不变）
10. 同时控制两个流，验证每个流的计时器独立运行

### 10.3 WebSocket测试（多流支持）

1. 打开两个数据大屏，分别选择不同的直播流（`stream-1` 和 `stream-2`）
2. 在后台管理系统修改 `stream-1` 的配置（评委、流程、票数）
3. 验证数据大屏A（显示 `stream-1`）是否实时收到更新
4. 验证数据大屏B（显示 `stream-2`）不受影响（不更新）
5. 在后台管理系统修改 `stream-2` 的配置
6. 验证数据大屏B（显示 `stream-2`）是否实时收到更新
7. 验证数据大屏A（显示 `stream-1`）不受影响（不更新）
8. 测试断线重连功能，验证重连后消息过滤仍然有效
9. 测试切换流时，验证WebSocket消息过滤是否正确更新

---

## 11. 常见问题

### Q1: 数据大屏不显示评委信息？

**A:** 检查以下几点：
1. 确认已选择正确的直播流
2. 确认已保存评委配置
3. 检查WebSocket连接是否正常
4. 查看浏览器控制台是否有错误信息

### Q2: 流程控制命令不生效？

**A:** 检查以下几点：
1. 确认WebSocket连接正常
2. 确认后台和大屏选择的是同一个直播流
3. 检查 `stream_id` 是否正确
4. 查看服务器日志是否有错误

### Q3: 票数不更新？

**A:** 检查以下几点：
1. 确认WebSocket连接状态
2. 确认投票接口正常
3. ⚠️ **检查 `stream_id` 参数是否正确传递**（投票接口和WebSocket事件都必须包含）
4. ⚠️ **检查数据大屏选择的流ID是否与消息的 `streamId` 匹配**
5. 查看服务器日志

### Q4: 多个直播流的数据互相干扰？

**A:** 检查以下几点：
1. ⚠️ **确认所有接口调用都包含正确的 `stream_id` 参数**
2. ⚠️ **确认所有WebSocket事件都包含 `streamId` 字段**
3. 检查数据大屏的消息过滤逻辑是否正确
4. 验证不同流的配置是否保存在不同的数据记录中
5. 检查数据库存储结构，确保按 `streamId` 分开存储

---

## 12. 数据流向和联动说明

### 12.1 数据流向

**数据流向：**
1. **小程序投票** → `POST /api/user-vote` → 后端更新票数 → WebSocket广播 → 数据大屏更新
2. **后台管理** → `POST /api/admin/judges` → 后端保存配置 → WebSocket广播 → 数据大屏更新
3. **流程控制** → `POST /api/admin/debate-flow/control` → 后端验证命令 → WebSocket广播 → 数据大屏执行
4. **票数管理** → `POST /api/admin/live/update-votes` → 后端更新票数 → WebSocket广播 → 数据大屏更新

---

### 12.2 关键联动点说明

#### 1. 小程序投票 → 数据大屏更新（多流独立）

**流程：**
1. 小程序调用 `POST /api/user-vote` 提交投票，**必须包含 `stream_id` 参数**
2. 后端更新**该流**的票数数据（不影响其他流）
3. 后端广播 `votes-updated` 事件，**事件中包含 `streamId` 字段**
4. 数据大屏接收事件，检查 `streamId` 是否匹配当前流
5. 如果匹配，更新显示并记录到 `voteHistory`；如果不匹配，忽略事件

**关键点：**
- ⚠️ **多流支持**：每个直播流的票数完全独立
- 数据大屏会根据 `streamId` 严格过滤消息，只处理匹配的直播流
- 如果消息没有 `streamId`，视为全局更新（不推荐，建议所有消息都包含 `streamId`）
- 不同直播流的投票互不影响

#### 2. 后台管理 → 数据大屏实时同步（多流独立）

**评委管理联动：**
- 后台保存评委配置（指定 `stream_id`） → WebSocket广播（包含 `streamId`） → 数据大屏检查 `streamId` 匹配后实时更新评委信息
- ⚠️ **多流支持**：每个直播流有独立的评委配置，互不影响

**流程控制联动：**
- 后台发送控制命令（指定 `stream_id`） → WebSocket广播（包含 `streamId`） → 数据大屏检查 `streamId` 匹配后执行命令并更新计时器
- ⚠️ **多流支持**：每个直播流有独立的计时器状态，可以同时运行不同的环节

**票数管理联动：**
- 后台设置/增加票数（指定 `stream_id`） → WebSocket广播（包含 `streamId`） → 数据大屏检查 `streamId` 匹配后实时更新票数显示
- ⚠️ **多流支持**：每个直播流有独立的票数数据，管理操作只影响指定的流

#### 3. 数据大屏初始化流程（多流支持）

**启动时：**
1. 选择直播流（从URL参数 `?stream_id=xxx` 或下拉框）
2. 调用 `GET /api/admin/streams` 获取流列表（**复用小程序已有接口**）
3. 调用 `GET /api/admin/dashboard` 获取票数数据（**复用小程序已有接口，统一数据源**）
4. 调用 `GET /api/admin/judges?stream_id=xxx` 获取**该流**的评委信息
5. 调用 `GET /api/admin/debate-flow?stream_id=xxx` 获取**该流**的流程配置
6. 连接WebSocket接收实时更新
7. 设置当前流的 `streamId`，用于过滤WebSocket消息
8. 初始化该流的 `voteHistory`（用于趋势图表）

**切换流时（多流独立管理）：**
- ⚠️ **多流支持**：切换流时，数据大屏会：
  1. **保存当前流的状态**（可选，用于后续切换回来时恢复）
  2. **更新当前流的 `streamId`** 为新的流ID
  3. **清空当前显示**（票数、评委、流程、计时器）
  4. **重新加载新流的所有数据**：
     - 调用 `GET /api/admin/dashboard` 获取票数数据（**复用小程序已有接口**）
     - 调用 `GET /api/admin/judges?stream_id=新流ID` 获取新流的评委信息
     - 调用 `GET /api/admin/debate-flow?stream_id=新流ID` 获取新流的流程配置
  5. **重置计时器状态**（新流有独立的计时器，从初始状态开始）
  6. **清空票数历史记录**（`voteHistory`，新流重新开始记录）
  7. **更新WebSocket消息过滤条件**（只处理新流的消息）
  8. **更新显示**（流名称、状态指示器等）
  9. **只处理匹配新 `streamId` 的消息**，忽略其他流的消息

**多流独立管理说明：**
- 每个直播流拥有完全独立的状态：
  - 独立的票数数据（正方/反方票数）
  - 独立的评委配置（3位评委信息）
  - 独立的辩论流程配置（环节、时长、顺序）
  - 独立的流程控制状态（计时器、当前环节、剩余时间）
  - 独立的票数历史记录（`voteHistory`，用于趋势图表）
- 切换流时，所有状态都会切换到新流对应的状态
- 不同流的数据互不影响，可以同时管理多个流

---

### 12.3 stream_id 过滤规则（多流独立处理）

**重要：** 所有WebSocket事件**必须**包含 `streamId` 字段，数据大屏会根据此字段严格过滤消息。

**过滤逻辑：**
```javascript
// 数据大屏的过滤逻辑（多流支持）
const messageStreamId = message.data.streamId;
const currentStreamId = getCurrentStreamId(); // 当前选择的直播流ID

// 严格过滤：只处理匹配的流
if (messageStreamId && messageStreamId !== currentStreamId) {
  // 忽略不属于当前流的消息（其他流的更新不影响当前流）
  console.log(`⏩ 忽略其他流的消息: ${messageStreamId}, 当前流: ${currentStreamId}`);
  return;
}

// 处理消息（streamId匹配或没有streamId）
if (!messageStreamId || messageStreamId === currentStreamId) {
  // 更新显示
  updateDisplay(message.data);
}
```

**多流处理规则：**
- ⚠️ **必须包含 streamId**：所有WebSocket事件都应该包含 `streamId` 字段
- **严格匹配**：数据大屏只处理 `streamId === currentStreamId` 的消息
- **独立处理**：不同直播流的消息互不影响，每个流独立运行
- **特殊情况**：如果消息没有 `streamId` 或 `streamId === null`，视为全局消息（不推荐，建议所有消息都包含 `streamId`）

**示例场景：**
- 场景1：数据大屏A显示 `stream-1`，收到 `stream-2` 的票数更新 → **忽略**
- 场景2：数据大屏A显示 `stream-1`，收到 `stream-1` 的票数更新 → **处理并更新显示**
- 场景3：数据大屏A显示 `stream-1`，收到没有 `streamId` 的消息 → **处理（全局消息）**

---

## 13. 其他相关接口

### 13.1 获取用户列表（用于评委管理）

> **✅ 已实现，直接使用**
> - `GET /api/admin/users` - 获取用户列表（用于评委管理页面选择评委）

---

## 14. 小程序投票接口（数据来源）

> **说明：** 此接口是小程序用户投票的入口，也是数据大屏票数更新的数据来源

### 14.1 用户投票接口

> **✅ 已实现，直接使用**
> - `POST /api/user-vote` - 用户投票接口（支持100票分配制和增量投票两种模式，自动广播votes-updated事件）

> **说明：** 此接口是小程序用户投票的入口，也是数据大屏票数更新的数据来源

---

## 15. 功能完整性检查清单

### 15.1 数据大屏功能检查

- [x] 加载直播流列表（**使用 `GET /api/admin/streams`，复用小程序已有接口**）
- [x] 加载票数数据（**使用 `GET /api/admin/dashboard`，复用小程序已有接口，统一数据源**）
- [x] 加载评委信息（支持stream_id，按流独立）
- [x] 加载辩论流程配置（支持stream_id，按流独立）
- [x] **切换直播流功能**（切换时重新加载所有数据）
- [x] WebSocket连接和消息接收
- [x] WebSocket消息按streamId过滤（只处理当前流的消息）
- [x] 票数实时更新显示（按流独立，**和小程序使用相同的数据源**）
- [x] 评委信息实时更新显示（按流独立）
- [x] 流程配置实时更新（按流独立）
- [x] 流程控制命令执行（start, pause, resume, reset, next, prev，按流独立）
- [x] 计时器功能（开始、暂停、继续、重置，按流独立）
- [x] 环节切换功能（下一环节、上一环节，按流独立）
- [ ] ⚠️ **前端实现：`startSegment(segmentIndex)` 函数** - 用于从指定环节开始计时（前端代码实现）
- [ ] ⚠️ **前端确认：`prevSegment()` 函数名** - 确认是否使用 `previousSegment()` 函数名（前端代码确认）
- [x] 票数趋势图表显示（按流独立记录历史）
- [x] 评委投票对抗条显示（按流独立）
- [x] 自动刷新票数（每5秒，按当前流刷新，**使用 `GET /api/admin/dashboard`**）

### 15.2 后台管理系统功能检查

#### 评委管理（多流独立管理）
- [x] 加载直播流列表
- [x] **选择直播流**（切换流时加载对应流的评委配置）
- [x] 加载评委配置（支持stream_id，按流独立）
- [x] 保存评委配置（支持stream_id，按流独立保存）
- [x] 上传头像功能
- [x] 从用户选择评委
- [x] **切换流时自动加载新流的评委配置**
- [x] ✅ **获取用户列表接口** - `GET /api/admin/users` 已实现，直接使用

#### 流程控制（多流独立管理）
- [x] 加载直播流列表
- [x] **选择直播流**（切换流时加载对应流的流程配置）
- [x] 加载流程配置（支持stream_id，按流独立）
- [x] 保存流程配置（支持stream_id，按流独立保存）
- [x] 发送流程控制命令（支持stream_id，按流独立控制）
- [x] 所有控制命令（start, pause, resume, reset, next, prev）
- [x] **切换流时自动加载新流的流程配置**
- [x] **不同流的流程控制完全独立**（可以同时控制多个流）

#### 票数管理（多流独立管理）
- [x] 加载直播流列表
- [x] **选择直播流**（切换流时加载对应流的票数）
- [x] 加载票数数据（支持stream_id，按流独立）
- [x] 设置票数功能（支持streamId，按流独立设置）
- [x] 增加票数功能（支持streamId，按流独立增加）
- [x] 票数设置/增加功能（支持streamId，按流独立调整）
- [x] **切换流时自动加载新流的票数数据**
- [x] **不同流的票数完全独立**（互不影响）

### 15.3 交互流程检查（多流独立管理）

#### 评委管理 → 数据大屏（多流独立）
- [x] 后台选择直播流A → 加载流A的评委配置
- [x] 后台保存流A的评委配置 → WebSocket广播（包含streamId: "流A"） → 数据大屏检查streamId匹配后实时更新
- [x] 后台切换到直播流B → 加载流B的评委配置（流A的配置不受影响）
- [x] 后台保存流B的评委配置 → WebSocket广播（包含streamId: "流B"） → 数据大屏检查streamId匹配后实时更新
- [x] **数据大屏切换流时**：自动加载新流的评委配置，显示新流的评委信息
- [x] **多流独立**：不同流的评委配置完全独立，互不影响

#### 流程控制 → 数据大屏（多流独立）
- [x] 后台选择直播流A → 加载流A的流程配置
- [x] 后台保存流A的流程配置 → WebSocket广播（包含streamId: "流A"） → 数据大屏检查streamId匹配后实时更新
- [x] 后台发送流A的控制命令 → WebSocket广播（包含streamId: "流A"） → 数据大屏检查streamId匹配后执行命令
- [x] 后台切换到直播流B → 加载流B的流程配置（流A的流程状态不受影响）
- [x] 后台发送流B的控制命令 → WebSocket广播（包含streamId: "流B"） → 数据大屏检查streamId匹配后执行命令
- [x] **数据大屏切换流时**：自动加载新流的流程配置，重置计时器状态
- [x] **多流独立**：不同流的流程控制和计时器状态完全独立，可以同时运行

#### 票数管理 → 数据大屏（多流独立）
- [x] 后台选择直播流A → 加载流A的票数数据
- [x] 后台设置/增加/重置流A的票数 → WebSocket广播（包含streamId: "流A"） → 数据大屏检查streamId匹配后实时更新
- [x] 后台切换到直播流B → 加载流B的票数数据（流A的票数不受影响）
- [x] 后台设置/增加/重置流B的票数 → WebSocket广播（包含streamId: "流B"） → 数据大屏检查streamId匹配后实时更新
- [x] **数据大屏切换流时**：自动加载新流的票数数据，清空票数历史记录
- [x] **多流独立**：不同流的票数数据完全独立，互不影响

#### 小程序投票 → 数据大屏（多流独立）
- [x] 小程序投票（指定streamId: "流A"） → 后端处理 → WebSocket广播（包含streamId: "流A"） → 数据大屏检查streamId匹配后实时更新
- [x] 小程序投票（指定streamId: "流B"） → 后端处理 → WebSocket广播（包含streamId: "流B"） → 数据大屏检查streamId匹配后实时更新
- [x] **数据大屏切换流时**：只接收新流的投票更新，忽略其他流的投票
- [x] **多流独立**：不同流的投票互不影响，票数独立累加

### 15.4 状态与改造结果

#### 接口路径统一（高优先级）

1. ⚠️ **数据大屏复用已有接口** - 数据大屏应该使用以下已有接口，不需要创建v1版本：
   - ✅ `GET /api/admin/dashboard` - **数据大屏获取票数**（复用小程序已有接口，统一数据源）
   - ✅ `GET /api/admin/streams` - **数据大屏获取流列表**（复用小程序已有接口，统一数据源）
   - ✅ `GET /api/admin/votes` - 数据大屏获取票数（可选，更简洁的接口）

2. ⚠️ **可选：v1版本路由别名** - 如果后台管理系统需要使用v1版本的接口路径，可以在server.js中添加路由别名（复用已有处理逻辑）：
   - `POST /api/v1/user-vote` → 可指向 `POST /api/user-vote`（已实现）
   - `GET /api/v1/admin/users` → 可指向 `GET /api/admin/users`（已实现）
   - `POST /api/v1/admin/live/update-votes` → 可指向 `POST /api/admin/live/update-votes`（已实现）
   
   **注意**：这些v1版本的路由别名不是必需的，可以直接使用非v1版本的接口路径。

3. ✅ **接口功能增强（多流支持）** 已完成：
  - `GET /api/admin/dashboard` 支持 `stream_id`，返回对应流票数数据
  - `GET /api/admin/votes` 支持 `stream_id`，返回对应流票数数据
  - `PUT /api/admin/votes` 支持 `stream_id`，按流更新票数并广播
  - `POST /api/user-vote` 支持 `streamId` 与 `{request: {...}}` 包装格式，按流累加票数并广播

4. ⚠️ **可选：小程序投票数据格式增强** - 当前接口已支持直接调用格式，如需支持 `request` 字段包装格式，可以添加处理逻辑：
   - 当前支持：`{leftVotes, rightVotes, streamId, userId}`（直接调用）
   - 可选支持：`{request: {leftVotes, rightVotes, streamId, userId}}`（小程序实际发送）
   - **处理建议**：在接口中添加自动解包逻辑，兼容两种格式
   
5. ✅ **多流独立票数存储** 已完成：后端维护 `streamVotes[streamId]` 独立统计，每个流互不影响

#### 前端代码实现问题

4. ⚠️ **前端实现缺失函数** - 数据大屏前端代码中需要实现 `startSegment(segmentIndex)` 函数
5. ⚠️ **前端函数名统一** - 确认 `prevSegment()` 和 `previousSegment()` 是否应该统一（前端代码确认）

#### WebSocket事件

6. ✅ **WebSocket事件增强（多流支持）** 已完成：所有票数相关广播均携带 `streamId`
  - `votes-updated` 事件在用户投票与后台票数更新、重置时均包含 `streamId`
  - 评委与流程相关事件已包含 `streamId`

---

## 16. 更新日志

### v1.6.0 (2025-11-17)
- ✅ 多流票数存储与查询：后端实现 `streamVotes`，所有票数接口与广播支持 `streamId`
- ✅ 接口统一与复用：数据大屏使用 `GET /api/admin/dashboard` 与 `GET /api/admin/streams`
- ✅ WebSocket地址说明：与页面同源的 `/ws`
- ✅ 用户投票接口兼容 `{request: {...}}` 包装格式

### v1.5.0 (2025-11-15)
- ✅ **接口复用说明** - 明确数据大屏应复用小程序已有接口，统一数据源
- ✅ **已实现接口清单** - 列出所有已实现的接口，可直接使用，无需后端开发
- ✅ **接口路径统一** - 数据大屏使用 `GET /api/admin/dashboard` 和 `GET /api/admin/streams`，与小程序保持一致

---

**文档维护者：** 后端开发团队  
**最后更新：** 2025-11-17  
**版本：** v1.6.0

